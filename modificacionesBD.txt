BEGIN;

-- ---------------------------------------------------------
-- 1. CREACIÓN DE NUEVAS TABLAS (Web & Carrito)
-- ---------------------------------------------------------

-- Tabla de Usuarios Web
CREATE TABLE IF NOT EXISTS web_users (
    id SERIAL PRIMARY KEY,
    username TEXT UNIQUE,
    fullname TEXT,
    password TEXT,
    email TEXT,
    phone TEXT,
    domicilio TEXT,
    cuit TEXT UNIQUE,
    role TEXT,
    status TEXT,
    session_token TEXT,
    profile_image_url TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla de Carritos (Cabecera)
CREATE TABLE IF NOT EXISTS web_carts (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_web_carts_user FOREIGN KEY (user_id) REFERENCES web_users(id)
);

-- Tabla de Items del Carrito (Detalle)
CREATE TABLE IF NOT EXISTS web_cart_items (
    id SERIAL PRIMARY KEY,
    cart_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    variant_id INTEGER NOT NULL, -- Importante para stock
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_cart_items_cart FOREIGN KEY (cart_id) REFERENCES web_carts(id),
    CONSTRAINT fk_cart_items_product FOREIGN KEY (product_id) REFERENCES products(id),
    CONSTRAINT fk_cart_items_variant FOREIGN KEY (variant_id) REFERENCES warehouse_stock_variants(id)
);

-- ---------------------------------------------------------
-- 2. MODIFICACIÓN DE LA TABLA PRODUCTS
-- ---------------------------------------------------------

-- Agregar columnas para la tienda online
ALTER TABLE products ADD COLUMN IF NOT EXISTS en_tienda_online BOOLEAN DEFAULT FALSE;
ALTER TABLE products ADD COLUMN IF NOT EXISTS nombre_web TEXT;
ALTER TABLE products ADD COLUMN IF NOT EXISTS descripcion_web TEXT;
ALTER TABLE products ADD COLUMN IF NOT EXISTS slug TEXT;

-- Crear restricción de unicidad para el slug (para URLs amigables)
-- Nota: En Postgres se hace agregando un constraint
ALTER TABLE products DROP CONSTRAINT IF EXISTS uq_products_slug; -- Por seguridad si corres esto dos veces
ALTER TABLE products ADD CONSTRAINT uq_products_slug UNIQUE (slug);

-- Borrar la columna images_ids (si existía)
ALTER TABLE products DROP COLUMN IF EXISTS images_ids;

-- ---------------------------------------------------------
-- 3. MODIFICACIÓN DE LA TABLA SALES (Ventas)
-- ---------------------------------------------------------

ALTER TABLE sales ADD COLUMN IF NOT EXISTS origin TEXT DEFAULT 'local';
ALTER TABLE sales ADD COLUMN IF NOT EXISTS shipping_address TEXT;
ALTER TABLE sales ADD COLUMN IF NOT EXISTS shipping_status TEXT;
ALTER TABLE sales ADD COLUMN IF NOT EXISTS external_payment_id TEXT;
ALTER TABLE sales ADD COLUMN IF NOT EXISTS shipping_cost NUMERIC(10,2) DEFAULT 0;
ALTER TABLE sales ADD COLUMN IF NOT EXISTS web_user_id INTEGER;

-- Agregar la Foreign Key hacia el usuario web
ALTER TABLE sales 
    ADD CONSTRAINT fk_sales_web_user 
    FOREIGN KEY (web_user_id) REFERENCES web_users(id);

-- ---------------------------------------------------------
-- 4. ARREGLO DE LA TABLA IMAGES
-- ---------------------------------------------------------
-- Objetivo: Permitir que image_data sea NULL y agregar image_url

-- 1. Agregar la columna de URL
ALTER TABLE images ADD COLUMN IF NOT EXISTS image_url TEXT;

-- 2. Quitar la restricción NOT NULL de la columna binaria (BYTEA)
ALTER TABLE images ALTER COLUMN image_data DROP NOT NULL;

COMMIT;

Para correr todo esto tengo que: 
1. Primero hacer un backup de la base de datos:
pg_dump -U tu_usuario_postgres -d nombre_de_tu_bd > backup_seguridad.sql

2. Creamos un archivo:
nano migracion_tienda.sql
Pegamos lo de arriba

3. Ejecutamos el archivo:
psql -U tu_usuario -d nombre_de_tu_bd -f migracion_tienda.sql

Si todo salio bien voy a ver el commit. 